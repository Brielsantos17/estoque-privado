<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Litoral Brasil</title>
    <style>
        :root {
            --primary: #005691; --bg: #f4f6f9; --white: #ffffff;
            --gold: #fbc02d; --danger: #e74c3c; --success: #27ae60;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg); color: #333; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- MENU INFERIOR (SEMPRE FIXO) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: var(--primary); display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            background: none; border: none; color: rgba(255,255,255,0.6);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.75rem; gap: 4px; width: 100%; height: 100%; cursor: pointer;
        }
        .nav-btn span { font-size: 1.4rem; }
        .nav-btn.active { color: var(--gold); font-weight: bold; }
        .nav-btn.active span { transform: scale(1.1); transition: 0.2s; }

        /* --- CONTE√öDO --- */
        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; /* Espa√ßo pro menu */ }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* --- UI ELEMENTS --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .product-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
        .product-card img { width: 100%; height: 150px; object-fit: cover; background: #eee; }
        .info-box { padding: 10px; }
        
        .filters-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .btn-pill { background: white; border: 1px solid #ddd; padding: 6px 16px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; color: #555; }
        .btn-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 16px; background: white; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-success { background: var(--success); } .btn-danger { background: var(--danger); }
        .btn-primary { background: var(--primary); } .btn-pink { background: #e84393; }

        /* --- FLUTUANTES --- */
        .cart-float { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 3px solid white; z-index: 900; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 2px solid white; font-weight: bold; }

        /* --- MODAIS & DRAWER --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; display: none; }
        .drawer { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; z-index: 1200; transition: 0.3s; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .drawer.open { bottom: 0; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; padding: 25px; border-radius: 12px; z-index: 1300; display: none; max-height: 90vh; overflow-y: auto; }
        
        .builder-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .build-item { min-width: 100px; text-align: center; border: 1px solid #eee; padding: 5px; border-radius: 8px; }
        .build-item.selected { border: 2px solid var(--primary); background: #e3f2fd; }
        .build-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; }

        /* Table Responsive */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .kpi-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

<div id="pdv" class="view-section active">
    <div class="top-bar">
        <h2 style="margin:0; color:var(--primary);">Litoral Brasil</h2>
        <small style="color:#777;">Online ‚òÅÔ∏è</small>
    </div>
    
    <div class="filters-scroll">
        <button class="btn-pill active" onclick="filter('todos', this)">Todos</button>
        <button class="btn-pill" onclick="filter('Suti√£', this)">Suti√£</button>
        <button class="btn-pill" onclick="filter('Calcinha', this)">Calcinha</button>
        <button class="btn-pill" onclick="filter('Conjunto', this)">Conjunto</button>
        <button class="btn-pill" onclick="filter('Fit-Top', this)">Top Fit</button>
        <button class="btn-pill" onclick="filter('Fit-Cal√ßa', this)">Legging</button>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="search" placeholder="Buscar..." onkeyup="renderPDV()" style="margin:0; flex:1;">
        <button onclick="openBuilder()" style="background:var(--primary); color:white; border:none; border-radius:8px; width:50px;">üëô</button>
    </div>

    <div id="grid" class="product-grid"></div>
</div>

<div id="clientes" class="view-section">
    <div class="top-bar"><h2>Clientes</h2><button onclick="openModal('modal-cli')" style="background:none; border:1px solid #ddd; padding:5px 15px; border-radius:20px;">+ Novo</button></div>
    <input type="text" id="search-cli" placeholder="Buscar..." onkeyup="renderCli()">
    <div class="card"><table id="table-cli"></table></div>
</div>

<div id="estoque" class="view-section">
    <div class="top-bar"><h2>Estoque</h2></div>
    <div class="card">
        <h3>Novo Produto</h3>
        <form onsubmit="saveProd(event)">
            <label>Modelo</label><input type="text" id="cad-name" required>
            <div style="display:flex; gap:10px;">
                <select id="cad-type"><option value="Suti√£">Suti√£</option><option value="Calcinha">Calcinha</option><option value="Conjunto">Conjunto</option><option value="Fit-Top">Top Fit</option><option value="Fit-Cal√ßa">Legging</option></select>
                <select id="cad-size"><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option></select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="number" id="cad-price" placeholder="Pre√ßo" step="0.01" required>
                <input type="number" id="cad-qty" placeholder="Qtd" required>
            </div>
            <input type="file" onchange="procImg(this, 'new')" style="padding:5px;">
            <img id="cad-prev" style="width:60px; height:60px; object-fit:cover; display:none; border-radius:6px; margin-bottom:10px;">
            <button class="btn btn-success">SALVAR</button>
        </form>
    </div>
    <div class="card">
        <h3>Lista</h3>
        <input type="text" id="search-stk" placeholder="Filtrar..." onkeyup="renderStk()">
        <table id="table-stk"></table>
    </div>
</div>

<div id="finan" class="view-section">
    <div class="top-bar"><h2>Financeiro</h2></div>
    <div class="kpi-box">
        <div class="kpi"><small>Faturamento</small><br><b style="font-size:1.2rem;">R$ <span id="kpi-fat">0.00</span></b></div>
        <div class="kpi"><small>Vendas</small><br><b style="font-size:1.2rem;" id="kpi-count">0</b></div>
    </div>
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>Hist√≥rico</b> <button onclick="exportTxt()" style="border:none; background:#eee; padding:5px 10px; border-radius:5px;">üì• TXT</button></div>
        <div style="max-height:300px; overflow-y:auto;">
            <table id="table-sales"></table>
        </div>
    </div>
</div>

<div class="cart-float" onclick="toggleCart()">
    <span style="font-size:1.5rem;">üõí</span>
    <div class="cart-badge" id="cart-count">0</div>
</div>

<div class="overlay" id="overlay" onclick="closeAll()"></div>
<div class="drawer" id="drawer-cart">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Carrinho</h3> <span onclick="closeAll()" style="font-size:1.5rem;">‚úï</span></div>
    <div id="cart-items" style="max-height:40vh; overflow-y:auto; margin-bottom:15px;"></div>
    <div style="font-size:1.3rem; font-weight:bold; text-align:right; margin-bottom:15px;">Total: R$ <span id="cart-total">0.00</span></div>
    <button class="btn btn-success" onclick="openModal('modal-pay')">FINALIZAR VENDA</button>
    <button class="btn btn-danger" onclick="cart=[];renderCart();closeAll()">LIMPAR</button>
</div>

<div class="modal" id="modal-pay" style="display:none;">
    <h3>Pagamento</h3>
    <h1 style="text-align:center; color:var(--primary);">R$ <span id="pay-total">0.00</span></h1>
    <select id="pay-method"><option>Pix</option><option>Cr√©dito</option><option>D√©bito</option><option>Dinheiro</option></select>
    <input type="text" id="pay-cli" placeholder="Buscar Cliente..." onkeyup="findCliPay()">
    <div id="pay-cli-list" style="max-height:100px; overflow-y:auto; border:1px solid #eee;"></div>
    <button class="btn btn-success" onclick="finish()">CONFIRMAR</button>
</div>

<div class="modal" id="modal-cli" style="display:none;">
    <h3>Novo Cliente</h3>
    <input id="new-cli-name" placeholder="Nome">
    <input id="new-cli-phone" placeholder="WhatsApp">
    <button class="btn btn-primary" onclick="saveCli()">Salvar</button>
</div>

<div class="modal" id="modal-build" style="display:none; width:95%;">
    <h3>Montar Biqu√≠ni</h3>
    <p>Escolha o Top:</p>
    <div class="builder-row" id="row-tops"></div>
    <p>Escolha a Calcinha:</p>
    <div class="builder-row" id="row-bots"></div>
    <div style="margin-top:15px; text-align:right;"><b>Total: R$ <span id="build-total">0.00</span></b></div>
    <button class="btn btn-pink" onclick="addBuild()">ADICIONAR AO CARRINHO</button>
</div>

<div class="modal" id="modal-edit" style="display:none;">
    <h3>Editar</h3>
    <input type="hidden" id="edit-id">
    <input id="edit-name">
    <div style="display:flex; gap:10px;"><input id="edit-price" type="number"><input id="edit-qty" type="number"></div>
    <button class="btn btn-primary" onclick="saveEdit()">Atualizar</button>
    <button class="btn btn-danger" onclick="delProd()" style="margin-top:5px;">Excluir</button>
</div>

<nav class="bottom-nav">
    <button class="nav-btn active" onclick="nav('pdv', this)"><span>üõí</span>PDV</button>
    <button class="nav-btn" onclick="nav('clientes', this)"><span>üë•</span>Clientes</button>
    <button class="nav-btn" onclick="nav('estoque', this)"><span>üì¶</span>Estoque</button>
    <button class="nav-btn" onclick="nav('finan', this)"><span>üí∞</span>Finan</button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- COLE SUA CHAVE AQUI ---
    const firebaseConfig = {
      apiKey: "AIzaSyBotDA6areUMSRrXlSK3phr9DMbq6SD2YE",
      authDomain: "litoral-brasil-estoque.firebaseapp.com",
      projectId: "litoral-brasil-estoque",
      storageBucket: "litoral-brasil-estoque.firebasestorage.app",
      messagingSenderId: "52560426712",
      appId: "1:52560426712:web:182ce08d908dcd001ec9ad",
      measurementId: "G-W3L44XPTHY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- STATE ---
    let inv=[], cli=[], sales=[], cart=[];
    let selTop=null, selBot=null, selCli=null, tmpImg=null;
    const NO_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3C/svg%3E";

    // --- INIT (CORRIGIDO: Removida a linha que travava o site) ---
    window.onload = () => {
        // Escuta o banco de dados
        db.collection("inventory").onSnapshot(s=>{
            inv=[]; 
            s.forEach(d=>inv.push({...d.data(),id:d.id}));
            renderPDV();
            renderStk();
        });
        db.collection("customers").onSnapshot(s=>{
            cli=[];
            s.forEach(d=>cli.push({...d.data(),id:d.id}));
            renderCli();
        });
        db.collection("sales").orderBy("ts","desc").limit(50).onSnapshot(s=>{
            sales=[];
            s.forEach(d=>sales.push({...d.data(),id:d.id}));
            renderFin();
        });
    };

    // --- NAV ---
    function nav(id, btn) {
        if(id==='finan' && prompt('Senha:')!=='admin') return;
        document.querySelectorAll('.view-section').forEach(d=>d.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function closeAll() {
        document.querySelectorAll('.modal, .drawer, .overlay').forEach(e=>e.classList.remove('open') || (e.style.display='none'));
    }
    function openModal(id) { document.getElementById('overlay').style.display='block'; document.getElementById(id).style.display='block'; }
    function toggleCart() { 
        document.getElementById('overlay').style.display='block'; 
        document.getElementById('drawer-cart').classList.add('open'); 
        renderCart(); 
    }

    // --- PDV (BLINDADO) ---
    let catFilter = 'todos';
    function filter(c, b) { catFilter=c; document.querySelectorAll('.btn-pill').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderPDV(); }
    
    function renderPDV() {
        const t = document.getElementById('search').value.toLowerCase();
        const g = document.getElementById('grid'); g.innerHTML='';
        inv.filter(i=>{
            const name = i.name ? i.name.toLowerCase() : ''; // Prote√ß√£o contra nulos
            return (catFilter==='todos'||i.type===catFilter) && name.includes(t);
        }).forEach(i=>{
            const op = i.qty<1 ? 0.5 : 1;
            g.innerHTML += `<div class="product-card" style="opacity:${op}" onclick="addCart('${i.id}')">
                <div style="position:absolute;top:5px;right:5px;background:var(--primary);color:white;border-radius:50%;width:25px;height:25px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;">${i.size}</div>
                <img src="${i.img||NO_IMG}">
                <div class="info-box"><b>${i.name}</b><br><small>${i.type}</small><br><b style="color:var(--primary)">R$ ${i.price}</b></div>
            </div>`;
        });
    }

    // --- CART ---
    function addCart(id) {
        const i = inv.find(x=>x.id===id); if(!i || i.qty<1) return alert('Sem estoque');
        const has = cart.find(x=>x.id===id); if(has) has.q++; else cart.push({...i, q:1});
        updBadge();
    }
    function updBadge() { document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.q,0); }
    function renderCart() {
        const d = document.getElementById('cart-items'); d.innerHTML=''; let t=0;
        cart.forEach((c,ix)=>{
            t+=c.price*c.q;
            d.innerHTML+=`<div style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:10px 0;">
                <div><b>${c.name}</b> (${c.size})<br>${c.q}x R$ ${c.price}</div>
                <button onclick="cart.splice(${ix},1);renderCart();updBadge()" style="color:red;border:none;background:none;">üóëÔ∏è</button>
            </div>`;
        });
        document.getElementById('cart-total').innerText = document.getElementById('pay-total').innerText = t.toFixed(2);
    }
    
    function finish() {
        if(!cart.length) return;
        const b = db.batch();
        cart.forEach(c=>{ b.update(db.collection('inventory').doc(c.id), {qty: c.qty-c.q}); });
        const tot = parseFloat(document.getElementById('cart-total').innerText);
        b.set(db.collection('sales').doc(), {
            date: new Date().toLocaleString(), cli: selCli?selCli.name:'Avulso', tot: tot,
            pay: document.getElementById('pay-method').value, items: cart.map(x=>x.name).join(', '), ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        b.commit().then(()=>{ alert('Venda OK!'); cart=[]; closeAll(); updBadge(); });
    }

    // --- ADMIN ---
    function procImg(el, m) {
        const f = el.files[0]; if(!f) return;
        const r = new FileReader(); r.onload=e=>{
            tmpImg = e.target.result;
            if(m==='new') { document.getElementById('cad-prev').src=tmpImg; document.getElementById('cad-prev').style.display='block'; }
        }; r.readAsDataURL(f);
    }
    function saveProd(e) {
        e.preventDefault();
        db.collection('inventory').add({
            name: document.getElementById('cad-name').value, type: document.getElementById('cad-type').value,
            size: document.getElementById('cad-size').value, price: parseFloat(document.getElementById('cad-price').value),
            qty: parseInt(document.getElementById('cad-qty').value), img: tmpImg
        }).then(()=>{ alert('Salvo!'); e.target.reset(); tmpImg=null; document.getElementById('cad-prev').style.display='none'; });
    }
    
    function renderStk() {
        const t = document.getElementById('search-stk').value.toLowerCase();
        const tb = document.getElementById('table-stk'); tb.innerHTML='';
        inv.filter(i=>{
            const name = i.name ? i.name.toLowerCase() : '';
            return name.includes(t);
        }).forEach(i=>{
            tb.innerHTML+=`<tr><td>${i.name} (${i.size})</td><td>${i.qty}</td><td onclick="edit('${i.id}')">‚úèÔ∏è</td></tr>`;
        });
    }
    function edit(id) {
        const i = inv.find(x=>x.id===id);
        document.getElementById('edit-id').value=id; document.getElementById('edit-name').value=i.name;
        document.getElementById('edit-price').value=i.price; document.getElementById('edit-qty').value=i.qty;
        openModal('modal-edit');
    }
    function saveEdit() {
        const id = document.getElementById('edit-id').value;
        db.collection('inventory').doc(id).update({
            name: document.getElementById('edit-name').value, price: parseFloat(document.getElementById('edit-price').value),
            qty: parseInt(document.getElementById('edit-qty').value)
        }).then(()=>closeAll());
    }
    function delProd() { if(confirm('Apagar?')) db.collection('inventory').doc(document.getElementById('edit-id').value).delete().then(()=>closeAll()); }

    // --- CLIENTS & BUILDER ---
    function saveCli() { db.collection('customers').add({name:document.getElementById('new-cli-name').value, phone:document.getElementById('new-cli-phone').value}).then(()=>closeAll()); }
    function renderCli() { 
        const tb = document.getElementById('table-cli'); tb.innerHTML=''; 
        cli.filter(c=>{
            const name = c.name ? c.name.toLowerCase() : '';
            return name.includes(document.getElementById('search-cli').value.toLowerCase());
        }).forEach(c=>{
            tb.innerHTML+=`<tr><td>${c.name}</td><td>${c.phone}</td></tr>`;
        });
    }
    
    function findCliPay() {
        const t = document.getElementById('pay-cli').value.toLowerCase();
        const l = document.getElementById('pay-cli-list'); l.innerHTML='';
        cli.filter(c=>{
            const name = c.name ? c.name.toLowerCase() : '';
            return name.includes(t);
        }).forEach(c=>{
            l.innerHTML+=`<div onclick="selCli={name:'${c.name}',id:'${c.id}'};document.getElementById('pay-cli').value='${c.name}';this.parentElement.innerHTML=''" style="padding:5px;border-bottom:1px solid #eee;">${c.name}</div>`;
        });
    }

    function openBuilder() { 
        openModal('modal-build'); selTop=null; selBot=null; 
        const rt = document.getElementById('row-tops'); const rb = document.getElementById('row-bots'); rt.innerHTML=''; rb.innerHTML='';
        inv.filter(i=>i.type==='Suti√£'&&i.qty>0).forEach(i=>rt.innerHTML+=`<div class="build-item" onclick="selPart('top','${i.id}',this)"><img src="${i.img||NO_IMG}"><br>${i.name}</div>`);
        inv.filter(i=>i.type==='Calcinha'&&i.qty>0).forEach(i=>rb.innerHTML+=`<div class="build-item" onclick="selPart('bot','${i.id}',this)"><img src="${i.img||NO_IMG}"><br>${i.name}</div>`);
    }
    function selPart(t,id,el) {
        if(t==='top') selTop = inv.find(x=>x.id===id); else selBot = inv.find(x=>x.id===id);
        Array.from(el.parentNode.children).forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
        const tot = (selTop?selTop.price:0) + (selBot?selBot.price:0);
        document.getElementById('build-total').innerText = tot.toFixed(2);
    }
    function addBuild() { if(selTop) addCart(selTop.id); if(selBot) addCart(selBot.id); closeAll(); }

    function renderFin() {
        const t = sales.reduce((a,b)=>a+b.tot,0); document.getElementById('kpi-fat').innerText=t.toFixed(2); document.getElementById('kpi-count').innerText=sales.length;
        const tb = document.getElementById('table-sales'); tb.innerHTML='';
        sales.forEach(s=>tb.innerHTML+=`<tr><td>${s.date.split(' ')[0]}</td><td>${s.cli}</td><td>R$ ${s.tot}</td></tr>`);
    }
    function exportTxt() {
        let txt = "LITORAL BRASIL - VENDAS\n\n";
        sales.forEach(s=>txt+=`${s.date} | ${s.cli} | R$ ${s.tot.toFixed(2)}\nItem: ${s.items}\n----------------\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt],{type:'text/plain'})); a.download='vendas.txt'; a.click();
    }
</script>
</body>
</html>
