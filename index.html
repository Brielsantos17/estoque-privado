<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Litoral Brasil</title>
    <style>
        :root {
            --primary: #005691; --primary-dark: #004472; --gold: #fbc02d;
            --bg: #f4f6f9; --white: #ffffff; --text: #333333;
            --sidebar-width: 250px;
            --success: #27ae60; --danger: #e74c3c; --info: #3498db; --pink: #e84393;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* --- 1. LAYOUT PC (SIDEBAR) --- */
        .sidebar {
            width: var(--sidebar-width); background: var(--primary); color: white;
            display: flex; flex-direction: column; height: 100vh; z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .brand { padding: 25px; text-align: center; background: var(--primary-dark); border-bottom: 3px solid var(--gold); }
        .brand h1 { margin: 0; font-size: 1.4rem; letter-spacing: 1px; }
        
        .nav-links { flex: 1; padding-top: 20px; display: flex; flex-direction: column; gap: 5px; }
        .nav-btn-side {
            background: transparent; border: none; color: rgba(255,255,255,0.8);
            padding: 15px 25px; text-align: left; font-size: 1rem; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 15px; width: 100%;
        }
        .nav-btn-side:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 30px; }
        .nav-btn-side.active { background: var(--white); color: var(--primary); font-weight: bold; border-right: 5px solid var(--gold); }
        
        .user-panel { padding: 20px; background: rgba(0,0,0,0.1); text-align: center; font-size: 0.85rem; color: rgba(255,255,255,0.6); }

        /* --- 2. LAYOUT MOBILE (BARRA INFERIOR) --- */
        .bottom-nav { display: none; }

        /* --- CONTE√öDO PRINCIPAL --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        .top-bar {
            background: var(--white); height: 60px; display: flex; align-items: center;
            justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .view-container { flex: 1; padding: 30px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* VIEWS */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }

        /* CARDS E UI */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; position: relative; will-change: transform; content-visibility: auto; }
        .product-card:active { transform: scale(0.98); }
        .product-card img { width: 100%; height: 160px; object-fit: cover; background: #eee; loading: lazy; }
        .info-box { padding: 12px; }
        .size-badge { position: absolute; top: 8px; right: 8px; background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* FILTROS */
        .filters-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; scrollbar-width: none; }
        .filters-bar::-webkit-scrollbar { display: none; }
        .btn-filter { background: white; border: 1px solid #ddd; color: #555; border-radius: 20px; padding: 8px 18px; cursor: pointer; white-space: nowrap; transition: 0.2s; font-size: 0.9rem; }
        .btn-filter.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* TABELAS (DEFAULT PC) */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.85rem; }
        
        /* FORMULARIOS */
        .form-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; background: #fff; }
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; font-size: 1rem; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); } .btn-pink { background: var(--pink); }
        .btn:disabled { background: #b0bec5 !important; color: #fff !important; cursor: not-allowed; }

        /* FLUTUANTES */
        .cart-float { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 900; cursor: pointer; border: 3px solid white; transition: transform 0.2s; }
        .cart-float:active { transform: scale(0.9); }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; border: 2px solid white; font-weight: bold; }

        /* LOADING (BLUR + PULSE) */
        .loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .pulse-loader {
            width: 60px; height: 60px; background: var(--primary); border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem; box-shadow: 0 0 20px rgba(0,86,145, 0.4);
        }
        @keyframes pulse { 0% { transform: scale(0.9); } 70% { transform: scale(1); } 100% { transform: scale(0.9); } }

        /* LOADER DADOS */
        .data-loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 20px; text-align: center; }
        .data-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        .data-text { color: var(--primary); font-weight: 600; font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAIS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .overlay.visible { opacity: 1; }
        .modal-box { background: white; width: 500px; max-width: 90%; padding: 25px; border-radius: 12px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); transform: scale(0.9); transition: transform 0.3s; }
        .overlay.visible .modal-box { transform: scale(1); }

        .edit-img-container { text-align: center; margin-bottom: 15px; border: 2px dashed #ddd; padding: 15px; border-radius: 12px; background: #fafafa; }
        .edit-img-preview { width: 140px; height: 140px; object-fit: cover; border-radius: 8px; background: #eee; display: block; margin: 0 auto 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .cart-drawer { position: fixed; top: 0; right: -400px; width: 380px; height: 100%; background: white; z-index: 1100; transition: right 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: -5px 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .cart-drawer.open { right: 0; }

        /* BUILDER */
        .builder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .b-list { height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 5px; background: #fafafa; }
        .b-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 6px; }
        .b-item:active { background: #e3f2fd; }
        .b-item.selected { background: #e3f2fd; border: 1px solid var(--primary); }

        /* --- RESPONSIVIDADE (TRANSFORMA PC EM MOBILE) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { display: none; }
            
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
                background: var(--white); justify-content: space-around; align-items: center;
                box-shadow: 0 -2px 15px rgba(0,0,0,0.05); z-index: 999; border-top: 1px solid #eee;
            }
            .nav-btn-mobile {
                background: none; border: none; color: #999;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                font-size: 0.7rem; gap: 3px; width: 100%; height: 100%;
            }
            .nav-btn-mobile.active { color: var(--primary); font-weight: 600; }
            .nav-btn-mobile span { font-size: 1.5rem; margin-bottom: -2px; }

            .main-content { padding-bottom: 80px; }
            .view-container { padding: 15px; }
            .top-bar { padding: 0 15px; }
            .product-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
            .product-card img { height: 150px; }
            .cart-float { bottom: 80px; right: 20px; }
            .cart-drawer { width: 100%; right: -100%; }
            .modal-box { width: 95%; padding: 20px; }

            /* --- OTIMIZA√á√ÉO DA TABELA FINANCEIRA (LAYOUT MOBILE EM CARDS) --- */
            #table-sales thead { display: none; } /* Esconde o cabe√ßalho chato */
            #table-sales, #table-sales tbody, #table-sales tr, #table-sales td { display: block; width: 100%; }
            #table-sales tr {
                background: white; border: 1px solid #eee; border-radius: 10px; margin-bottom: 12px;
                padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
            }
            #table-sales td {
                padding: 3px 0; border: none; text-align: left;
            }
            /* Visual dos campos no card mobile */
            #table-sales td:nth-child(1) { font-size: 0.8rem; color: #888; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; } /* Data */
            #table-sales td:nth-child(2) { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; } /* Cliente */
            #table-sales td:nth-child(3) { font-size: 0.9rem; color: #555; background: #f9f9f9; padding: 5px; border-radius: 5px; margin: 5px 0; } /* Itens */
            #table-sales td:nth-child(4) { display: inline-block; font-size: 0.8rem; background: #e3f2fd; color: var(--info); padding: 2px 8px; border-radius: 10px; } /* Pag */
            #table-sales td:nth-child(5) { position: absolute; top: 15px; right: 15px; font-size: 1.2rem; font-weight: bold; color: var(--success); } /* Valor */
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="brand"><h1>LITORAL BRASIL</h1></div>
    <div class="nav-links">
        <button class="nav-btn-side active" onclick="nav('pdv')" id="side-pdv"><span>üõí</span> PDV</button>
        <button class="nav-btn-side" onclick="nav('clientes')" id="side-clientes"><span>üë•</span> Clientes</button>
        <button class="nav-btn-side" onclick="nav('estoque')" id="side-estoque"><span>üì¶</span> Estoque</button>
        <button class="nav-btn-side" onclick="nav('financeiro')" id="side-financeiro"><span>üí∞</span> Financeiro</button>
        <button class="nav-btn-side" onclick="nav('cadastro')" id="side-cadastro"><span>‚ûï</span> Cadastro</button>
    </div>
    <div class="user-panel">Admin Logged</div>
</aside>

<div class="main-content">
    <div class="top-bar">
        <h3 style="color:var(--primary); margin:0;">Painel de Controle</h3>
        <span style="background:#e8f5e9; color:#2e7d32; padding:5px 12px; border-radius:15px; font-size:0.85rem; font-weight:bold;">‚óè Online</span>
    </div>

    <div class="view-container">
        
        <section id="pdv" class="view-section active">
            <div class="filters-bar">
                <button class="btn-filter active" onclick="filterPDV('todos', this)">Todos</button>
                <button class="btn-filter" onclick="filterPDV('Suti√£', this)">Suti√£s</button>
                <button class="btn-filter" onclick="filterPDV('Calcinha', this)">Calcinhas</button>
                <button class="btn-filter" onclick="filterPDV('Conjunto', this)">Conjuntos</button>
                <button class="btn-filter" onclick="filterPDV('Fit-Top', this)">Top Fit</button>
                <button class="btn-filter" onclick="filterPDV('Fit-Cal√ßa', this)">Legging</button>
                <button class="btn-filter" onclick="filterPDV('Fit-Macac√£o', this)">Macac√£o</button>
                <button class="btn-filter" onclick="filterPDV('Fit-Macaquinho', this)">Macaquinho</button>
            </div>
            
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <input type="text" id="pdv-search" placeholder="üîç Buscar..." onkeyup="renderPDV()" style="margin:0; border-radius:30px; border:none; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                <button class="btn btn-pink" onclick="openBuilder()" style="border-radius:30px; white-space:nowrap; padding: 0 25px;">üëô Montar</button>
            </div>

            <div id="pdv-loader" class="data-loader-container">
                <div class="data-spinner"></div>
                <div class="data-text">Carregando...<br>Estou trazendo todas as pe√ßas.</div>
            </div>

            <div id="pdv-grid" class="product-grid" style="display:none;"></div>
        </section>

        <section id="clientes" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Clientes</h2>
                <button class="btn btn-primary" onclick="openModal('modal-cliente')">+ Novo</button>
            </div>
            <input type="text" id="search-cli" placeholder="Buscar cliente..." onkeyup="renderCustomers()">
            <div style="overflow-x:auto;">
                <table style="margin-top:15px;"><thead style="background:#f8f9fa;"><tr><th>Nome</th><th>Telefone</th></tr></thead><tbody id="table-cli"></tbody></table>
            </div>
        </section>

        <section id="estoque" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Estoque</h2>
                <button class="btn btn-primary" onclick="nav('cadastro')">+ Adicionar</button>
            </div>
            <input type="text" id="stock-search" placeholder="Filtrar estoque..." onkeyup="renderStock()">
            <div style="overflow-x:auto;">
                <table style="margin-top:15px;"><thead><tr><th>Item</th><th>Tam</th><th>R$</th><th>Qtd</th><th>A√ß√£o</th></tr></thead><tbody id="table-stock"></tbody></table>
            </div>
        </section>

        <section id="financeiro" class="view-section">
            <h2>Financeiro</h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px;">
                <div style="background:white; padding:20px; border-radius:12px; border-left:5px solid var(--success); box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                    <small style="color:#888; font-weight:600; text-transform:uppercase;">Faturamento</small>
                    <div style="font-size:1.8rem; font-weight:bold; color:var(--text);">R$ <span id="fin-total">0.00</span></div>
                </div>
                <div style="background:white; padding:20px; border-radius:12px; border-left:5px solid var(--info); box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                    <small style="color:#888; font-weight:600; text-transform:uppercase;">Vendas</small>
                    <div style="font-size:1.8rem; font-weight:bold; color:var(--text);"><span id="fin-count">0</span></div>
                </div>
            </div>
            <div class="form-card" style="margin:0; max-width:100%; padding: 15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>√öltimas Vendas</h3>
                    <button class="btn" style="background:#333; padding: 8px 15px;" onclick="exportReport()">üìÑ Relat√≥rio</button>
                </div>
                <div style="max-height:500px; overflow-y:auto;">
                    <table id="table-sales-container">
                        <thead id="fin-table-head">
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Itens</th>
                                <th>Pag</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="table-sales"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="cadastro" class="view-section">
            <h2>Cadastrar Produto</h2>
            <div class="form-card">
                <form onsubmit="saveProduct(event)">
                    <label>Nome do Modelo</label>
                    <input type="text" id="cad-name" required placeholder="Ex: Cortininha On√ßa">
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label>Tipo</label>
                            <select id="cad-type">
                                <option value="Suti√£">Suti√£ (Biqu√≠ni)</option>
                                <option value="Calcinha">Calcinha</option>
                                <option value="Conjunto">Conjunto</option>
                                <option value="Fit-Top">Top Fitness</option>
                                <option value="Fit-Cal√ßa">Legging</option>
                                <option value="Fit-Macac√£o">Macac√£o</option>
                                <option value="Fit-Macaquinho">Macaquinho</option>
                            </select>
                        </div>
                        <div>
                            <label>Tamanho</label>
                            <select id="cad-size">
                                <option>PP</option><option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option><option>U</option>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label>Pre√ßo (R$)</label><input type="number" id="cad-price" step="0.01" required></div>
                        <div><label>Quantidade</label><input type="number" id="cad-qty" required></div>
                    </div>

                    <label>Foto do Produto</label>
                    <input type="file" accept="image/*" onchange="processImage(this, 'new')">
                    <div style="width:100px; height:100px; background:#f0f0f0; margin-top:10px; border-radius:8px; overflow:hidden;">
                        <img id="cad-preview" style="width:100%; height:100%; object-fit:cover; display:none;">
                    </div>

                    <button id="btn-save-new" class="btn btn-success" style="width:100%; margin-top:20px; height:50px; font-size:1.1rem;">SALVAR PRODUTO</button>
                </form>
            </div>
        </section>

    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-btn-mobile active" onclick="nav('pdv')" id="mob-pdv"><span>üõí</span>PDV</button>
    <button class="nav-btn-mobile" onclick="nav('clientes')" id="mob-clientes"><span>üë•</span>Cli</button>
    <button class="nav-btn-mobile" onclick="nav('estoque')" id="mob-estoque"><span>üì¶</span>Est</button>
    <button class="nav-btn-mobile" onclick="nav('financeiro')" id="mob-financeiro"><span>üí∞</span>Fin</button>
</nav>

<div class="cart-float" onclick="toggleCartDrawer()">
    <span style="font-size:1.5rem;">üõí</span>
    <div class="cart-badge" id="cart-count">0</div>
</div>

<div id="loading-overlay" class="loading-overlay">
    <div class="pulse-loader">üíæ</div>
    <div style="margin-top: 20px; font-weight: bold; color: #333; background:white; padding: 5px 15px; border-radius:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);">Salvando...</div>
</div>

<div class="overlay" id="overlay" onclick="closeAll()"></div>
<div class="cart-drawer" id="cart-drawer">
    <div style="padding:20px; background:var(--primary); color:white; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Seu Carrinho</h3>
        <button onclick="closeAll()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚úï</button>
    </div>
    <div style="flex:1; overflow-y:auto; padding:20px;" id="cart-list"></div>
    <div style="padding:20px; background:#f8f9fa; border-top:1px solid #eee;">
        <div style="font-size:1.5rem; font-weight:bold; text-align:right; margin-bottom:15px; color:var(--primary);">
            R$ <span id="cart-total">0.00</span>
        </div>
        <button class="btn btn-success" style="width:100%; margin-bottom:10px;" onclick="openCheckout()">FINALIZAR VENDA</button>
        <button class="btn btn-danger" style="width:100%;" onclick="clearCart()">LIMPAR</button>
    </div>
</div>

<div class="overlay" id="modal-overlay" style="z-index:1200; display:none;" onclick="document.getElementById('modal-overlay').classList.remove('visible'); setTimeout(()=>{document.getElementById('modal-overlay').style.display='none';document.querySelectorAll('.modal-box').forEach(m=>m.style.display='none')},200);"></div>

<div id="modal-checkout" class="modal-box" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1300; display:none;">
    <h2 style="margin-top:0;">Pagamento</h2>
    <h1 style="text-align:center; color:var(--primary); font-size:2.5rem;">R$ <span id="chk-total">0.00</span></h1>
    <label>Forma de Pagamento</label>
    <select id="chk-method">
        <option value="Pix">Pix</option>
        <option value="Cr√©dito">Cart√£o de Cr√©dito</option>
        <option value="D√©bito">Cart√£o de D√©bito</option>
        <option value="Dinheiro">Dinheiro</option>
    </select>
    <label>Vincular Cliente</label>
    <input type="text" id="chk-search-cli" placeholder="Digite nome..." onkeyup="searchCheckoutClient()">
    <div id="chk-results" style="border:1px solid #eee; max-height:100px; overflow-y:auto; display:none;"></div>
    <div id="chk-selected-cli" style="background:#e8f5e9; color:#2e7d32; padding:10px; border-radius:6px; margin-bottom:15px; display:none; font-weight:bold;"></div>
    <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="finishSale()">CONFIRMAR VENDA</button>
</div>

<div id="modal-builder" class="modal-box" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1300; display:none;">
    <h2 style="margin-top:0;">Montar Conjunto</h2>
    <div class="builder-grid">
        <div><h4>Parte de Cima</h4><div id="list-tops" class="b-list"></div></div>
        <div><h4>Parte de Baixo</h4><div id="list-bottoms" class="b-list"></div></div>
    </div>
    <div style="background:#f0f0f0; padding:15px; border-radius:8px; margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
        <div id="build-summary" style="font-size:0.9rem; color:#555;">Selecione...</div>
        <div style="font-weight:bold; font-size:1.2rem; color:var(--primary);">R$ <span id="build-total">0.00</span></div>
    </div>
    <button class="btn btn-pink" style="width:100%; margin-top:15px;" onclick="addComboToCart()">ADICIONAR AO CARRINHO</button>
</div>

<div id="modal-cliente" class="modal-box" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1300; display:none;">
    <h2 style="margin-top:0;">Novo Cliente</h2>
    <form onsubmit="saveCustomer(event)">
        <label>Nome Completo</label><input id="cli-name" required>
        <label>WhatsApp</label><input id="cli-phone" required>
        <button class="btn btn-primary" style="width:100%;">Salvar Cliente</button>
    </form>
</div>

<div id="modal-edit" class="modal-box" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1300; display:none;">
    <h2 style="margin-top:0; text-align:center;">Editar Produto</h2>
    <form onsubmit="saveEdit(event)">
        <input type="hidden" id="edit-id">
        
        <div class="edit-img-container">
            <img id="edit-preview" class="edit-img-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23aaa'%3ESem Foto%3C/text%3E%3C/svg%3E">
            <label style="display:block; margin-top:10px; cursor:pointer;">
                <span style="background:var(--primary); color:white; padding:8px 15px; border-radius:20px; font-size:0.9rem;">üì∑ Alterar Foto</span>
                <input type="file" accept="image/*" style="display:none;" onchange="processImage(this, 'edit')">
            </label>
        </div>

        <label>Nome</label><input id="edit-name">
        <label>Tamanho</label>
        <select id="edit-size" style="margin-bottom:15px;">
            <option>PP</option><option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option><option>U</option>
        </select>
        <div style="display:flex; gap:15px;">
            <div style="flex:1"><label>Pre√ßo</label><input id="edit-price" type="number" step="0.01"></div>
            <div style="flex:1"><label>Qtd</label><input id="edit-qty" type="number"></div>
        </div>
        
        <button id="btn-save-edit" class="btn btn-primary" style="width:100%; height:50px; font-size:1.1rem; margin-top:10px;">üíæ Atualizar</button>
        <button type="button" class="btn btn-danger" style="width:100%; margin-top:15px; background:#fff; color:var(--danger); border:1px solid var(--danger);" onclick="deleteItem(document.getElementById('edit-id').value)">üóëÔ∏è Excluir Produto</button>
    </form>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBotDA6areUMSRrXlSK3phr9DMbq6SD2YE",
      authDomain: "litoral-brasil-estoque.firebaseapp.com",
      projectId: "litoral-brasil-estoque",
      storageBucket: "litoral-brasil-estoque.firebasestorage.app",
      messagingSenderId: "52560426712",
      appId: "1:52560426712:web:182ce08d908dcd001ec9ad",
      measurementId: "G-W3L44XPTHY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Tenta cache para velocidade, ignora se der erro
    db.enablePersistence().catch(e => console.log("Persistencia: " + e.code));

    let inventory=[], customers=[], salesHistory=[], cart=[];
    let selTop=null, selBot=null, selectedClient=null, tempImg=null, editImg=null;
    // Vari√°vel para controlar o timeout do modal e evitar o bug de fechar sozinho
    let modalTimer = null; 
    
    const NO_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' fill='%23aaa'%3ESem Foto%3C/text%3E%3C/svg%3E";

    window.onload = function() {
        // Carregamento Otimizado
        db.collection("inventory").onSnapshot(s=>{ 
            inventory=[]; 
            s.forEach(d=>inventory.push({...d.data(),id:d.id})); 
            // Esconde loader e mostra dados
            const loader = document.getElementById('pdv-loader');
            if(loader) loader.style.display = 'none';
            const grid = document.getElementById('pdv-grid');
            if(grid) grid.style.display = 'grid';
            
            renderPDV(); renderStock(); 
        });
        
        db.collection("customers").onSnapshot(s=>{ 
            customers=[]; 
            s.forEach(d=>customers.push({...d.data(),id:d.id})); 
            renderCustomers(); 
        });
        
        db.collection("sales").orderBy("timestamp","desc").limit(50).onSnapshot(s=>{ 
            salesHistory=[]; 
            s.forEach(d=>salesHistory.push({...d.data(),id:d.id})); 
            renderFinancials(); 
        });
    };

    // --- HELPER DE LOADING & BLOQUEIO ---
    function setLoading(isLoading, btnId) {
        const overlay = document.getElementById('loading-overlay');
        if(overlay) overlay.style.display = isLoading ? 'flex' : 'none';
        
        if(btnId) {
            const btn = document.getElementById(btnId);
            if(btn) {
                if(isLoading) {
                    if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerText;
                    btn.innerText = "Processando...";
                    btn.disabled = true;
                } else {
                    btn.innerText = btn.dataset.originalText || "Salvar";
                    btn.disabled = false;
                }
            }
        }
    }

    // --- NAVEGA√á√ÉO ---
    function nav(id) {
        if(id==='financeiro' && prompt('Senha:')!=='litorallu') return;
        document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        document.querySelectorAll('.nav-btn-side, .nav-btn-mobile').forEach(b=>b.classList.remove('active'));
        if(document.getElementById('side-'+id)) document.getElementById('side-'+id).classList.add('active');
        if(document.getElementById('mob-'+id)) document.getElementById('mob-'+id).classList.add('active');
    }

    function closeAll() {
        // Fecha Gaveta e Overlay da Gaveta
        document.getElementById('overlay').style.display='none';
        document.getElementById('cart-drawer').classList.remove('open');
        
        // Fecha Modais com anima√ß√£o
        const modalOverlay = document.getElementById('modal-overlay');
        modalOverlay.classList.remove('visible');
        
        // Limpa timer anterior para n√£o encavalar
        if(modalTimer) clearTimeout(modalTimer);
        
        modalTimer = setTimeout(() => {
            modalOverlay.style.display = 'none';
            document.querySelectorAll('.modal-box').forEach(m => m.style.display = 'none');
        }, 200);
    }
    
    function openModal(id) { 
        // Se tiver timer de fechar rodando, cancela ele agora!
        if(modalTimer) clearTimeout(modalTimer);

        const overlay = document.getElementById('modal-overlay');
        // Garante que todos os outros modais fechem antes de abrir o novo
        document.querySelectorAll('.modal-box').forEach(m => m.style.display = 'none');
        
        overlay.style.display = 'flex';
        // Pequeno delay para a anima√ß√£o CSS pegar
        setTimeout(()=>overlay.classList.add('visible'), 10);
        
        const modal = document.getElementById(id);
        if(modal) modal.style.display='block'; 
    }
    
    function toggleCartDrawer() {
        document.getElementById('overlay').style.display='block';
        document.getElementById('cart-drawer').classList.add('open');
        renderCart();
    }

    // --- CORRE√á√ÉO DO BUG: OPEN CHECKOUT ---
    function openCheckout(){ 
        if(!cart.length) return alert("Carrinho vazio!");
        
        // AQUI ESTAVA O ERRO: Em vez de chamar closeAll() que fecha tudo com delay,
        // vamos fechar S√ì O CARRINHO manualmente e abrir o modal direto.
        
        document.getElementById('cart-drawer').classList.remove('open'); // Fecha gaveta
        document.getElementById('overlay').style.display='none'; // Fecha fundo da gaveta
        
        // Abre modal de pagamento imediatamente
        openModal('modal-checkout'); 
    }

    // --- L√ìGICA PDV ---
    let pdvFilter = 'todos';
    function filterPDV(t,b){ pdvFilter=t; document.querySelectorAll('.btn-filter').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderPDV(); }
    
    function renderPDV() {
        const g = document.getElementById('pdv-grid'); 
        if(!g) return;
        const t = document.getElementById('pdv-search').value.toLowerCase(); 
        
        const html = inventory.filter(i=>{
            const n = i.name ? i.name.toLowerCase() : '';
            return (pdvFilter==='todos'||i.type===pdvFilter) && n.includes(t);
        }).map(i => {
            const op = i.qty<1 ? 0.5 : 1;
            return `<div class="product-card" style="opacity:${op}" onclick="addToCart('${i.id}')">
                <div class="size-badge">${i.size}</div><img src="${i.img||NO_IMG}" loading="lazy">
                <div class="info-box"><b>${i.name}</b><br><small>${i.type}</small><br><span style="color:var(--primary);font-weight:bold;">R$ ${i.price}</span></div>
            </div>`;
        }).join('');
        g.innerHTML = html;
    }

    function addToCart(id) {
        const i = inventory.find(x=>x.id===id); if(i.qty<1) return alert('Sem Estoque');
        const h = cart.find(x=>x.id===id); if(h) h.q++; else cart.push({...i,q:1});
        document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.q,0);
        // Feedback visual
        const btn = document.querySelector('.cart-float');
        btn.style.transform = "scale(1.2)";
        setTimeout(()=>btn.style.transform = "scale(1)", 200);
    }
    
    function renderCart() {
        const d = document.getElementById('cart-list'); 
        let tot=0;
        d.innerHTML = cart.map((c,ix) => {
            tot += c.price*c.q;
            return `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:10px 0;">
                <div><b>${c.name}</b> (${c.size})<br>${c.q}x R$ ${c.price}</div>
                <button onclick="cart.splice(${ix},1);renderCart()" style="color:red;border:none;background:none;cursor:pointer;">üóëÔ∏è</button>
            </div>`;
        }).join('');
        
        const totalEl = document.getElementById('cart-total');
        const chkTotalEl = document.getElementById('chk-total');
        if(totalEl) totalEl.innerText = tot.toFixed(2);
        if(chkTotalEl) chkTotalEl.innerText = tot.toFixed(2);
    }
    function clearCart(){ cart=[]; renderCart(); document.getElementById('cart-count').innerText='0'; closeAll(); }

    function searchCheckoutClient() {
        const t = document.getElementById('chk-search-cli').value.toLowerCase(); 
        const r = document.getElementById('chk-results'); 
        if(!r) return;
        r.style.display='block';
        
        r.innerHTML = customers.filter(c=>(c.name||'').toLowerCase().includes(t)).map(c => 
            `<div style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;" onclick="selCli('${c.id}')">${c.name}</div>`
        ).join('');
    }
    function selCli(id) { 
        selectedClient=customers.find(c=>c.id===id); 
        document.getElementById('chk-selected-cli').innerText='Cliente: '+selectedClient.name; 
        document.getElementById('chk-selected-cli').style.display='block'; 
        document.getElementById('chk-results').style.display='none'; 
    }

    // --- FUN√á√ÉO DE FINALIZAR VENDA (REFOR√áADA) ---
    function finishSale() {
        if(cart.length === 0) return alert("Carrinho vazio!");
        
        // Bloqueia tela imediatamente
        setLoading(true);
        
        const batch = db.batch();
        
        // Atualiza estoque
        cart.forEach(c=>{ 
            const ref = db.collection('inventory').doc(c.id);
            // Prote√ß√£o: n√£o deixa estoque ficar negativo
            const novaQtd = Math.max(0, c.qty - c.q);
            batch.update(ref, {qty: novaQtd}); 
        });
        
        const tot = parseFloat(document.getElementById('chk-total').innerText);
        const method = document.getElementById('chk-method').value;
        const cliName = selectedClient ? selectedClient.name : 'Avulso';
        
        // Cria registro da venda
        const saleRef = db.collection('sales').doc();
        batch.set(saleRef, {
            date: new Date().toLocaleString(), 
            client: cliName, 
            total: tot,
            method: method, 
            items: cart.map(x=>x.name).join(', '), 
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Envia pro Firebase
        batch.commit()
        .then(()=>{ 
            setLoading(false); 
            alert('Venda Realizada com Sucesso!'); 
            cart = []; 
            renderCart();
            document.getElementById('cart-count').innerText='0';
            selectedClient = null;
            document.getElementById('chk-selected-cli').style.display='none';
            document.getElementById('chk-search-cli').value='';
            closeAll(); 
        })
        .catch(err=>{
            setLoading(false); 
            console.error(err);
            alert('Erro ao finalizar venda: Verifique sua conex√£o.');
        });
    }

    // --- CRUD ---
    function processImage(input, m) {
        if(input.files[0]) {
            const r = new FileReader(); r.onload=e=>{
                const i=new Image(); i.onload=()=>{
                    const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=200; c.height=(i.height*200)/i.width; x.drawImage(i,0,0,c.width,c.height);
                    const d=c.toDataURL('image/jpeg',0.6);
                    if(m==='new'){ tempImg=d; document.getElementById('cad-preview').src=d; document.getElementById('cad-preview').style.display='block'; }
                    else { editImg=d; document.getElementById('edit-preview').src=d; }
                }; i.src=e.target.result;
            }; r.readAsDataURL(input.files[0]);
        }
    }
    
    function saveProduct(e) {
        e.preventDefault();
        setLoading(true, 'btn-save-new');
        db.collection('inventory').add({
            name: document.getElementById('cad-name').value, type: document.getElementById('cad-type').value,
            size: document.getElementById('cad-size').value, price: parseFloat(document.getElementById('cad-price').value),
            qty: parseInt(document.getElementById('cad-qty').value), img: tempImg, createdAt: new Date()
        })
        .then(()=>{ 
            alert('Produto Salvo!'); e.target.reset(); tempImg=null; document.getElementById('cad-preview').style.display='none'; 
        })
        .catch(err => alert('Erro: ' + err))
        .finally(() => setLoading(false, 'btn-save-new'));
    }
    
    function renderStock() {
        const t = document.getElementById('stock-search').value.toLowerCase(); const tb = document.getElementById('table-stock'); 
        tb.innerHTML = inventory.filter(i=>(i.name||'').toLowerCase().includes(t)).map(i => 
            `<tr><td>${i.name}</td><td>${i.size}</td><td>${i.price}</td><td>${i.qty}</td><td><button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem;" onclick="openEdit('${i.id}')">Editar</button></td></tr>`
        ).join('');
    }
    
    function openEdit(id) {
        const i=inventory.find(x=>x.id===id); 
        document.getElementById('edit-id').value=id; 
        document.getElementById('edit-name').value=i.name;
        document.getElementById('edit-price').value=i.price; 
        document.getElementById('edit-qty').value=i.qty;
        document.getElementById('edit-size').value = i.size || 'U';
        editImg=i.img; 
        document.getElementById('edit-preview').src = i.img || NO_IMG;
        openModal('modal-edit');
    }
    
    function saveEdit(e) {
        e.preventDefault(); 
        setLoading(true, 'btn-save-edit');
        const id=document.getElementById('edit-id').value;
        const u = { 
            name:document.getElementById('edit-name').value, 
            price:parseFloat(document.getElementById('edit-price').value), 
            qty:parseInt(document.getElementById('edit-qty').value),
            size:document.getElementById('edit-size').value
        };
        if(editImg) u.img=editImg; 
        
        db.collection('inventory').doc(id).update(u)
        .then(()=>{ closeAll(); alert('Atualizado!'); })
        .catch(err => alert('Erro: ' + err))
        .finally(() => setLoading(false, 'btn-save-edit'));
    }
    
    function deleteItem(id){ 
        if(confirm('Excluir este item permanentemente?')) {
            setLoading(true);
            db.collection('inventory').doc(id).delete().then(()=>{ closeAll(); }).finally(() => setLoading(false));
        }
    }

    function saveCustomer(e){ e.preventDefault(); db.collection('customers').add({name:document.getElementById('cli-name').value, phone:document.getElementById('cli-phone').value}).then(()=>{ closeAll(); alert('Cliente Salvo'); }); }
    function renderCustomers(){ 
        const tb=document.getElementById('table-cli'); 
        tb.innerHTML = customers.filter(c=>(c.name||'').toLowerCase().includes(document.getElementById('search-cli').value.toLowerCase())).map(c => 
            `<tr><td>${c.name}</td><td>${c.phone}</td></tr>`
        ).join('');
    }
    
    // --- FUN√á√ÉO PARA ABREVIAR NOMES ---
    function shortenMethod(m) {
        if(!m) return '-';
        if(m.includes('Cr√©dito')) return 'Cr√©dito';
        if(m.includes('D√©bito')) return 'D√©bito';
        if(m.includes('Dinheiro')) return 'Din';
        return m;
    }

    function renderFinancials(){
        const tot=salesHistory.reduce((a,b)=>a+b.total,0); document.getElementById('fin-total').innerText=tot.toFixed(2); document.getElementById('fin-count').innerText=salesHistory.length;
        const tb=document.getElementById('table-sales'); 
        
        tb.innerHTML = salesHistory.map(s => {
            const shortMethod = shortenMethod(s.method);
            return `<tr>
                <td>${s.date.split(' ')[0]}</td>
                <td>${s.client}</td>
                <td style="font-size:0.8rem; color:#555;">${s.items}</td>
                <td>${shortMethod}</td>
                <td style="font-weight:bold; color:var(--success);">R$ ${s.total.toFixed(2)}</td>
            </tr>`;
        }).join('');
    }

    function exportReport(){
        let t = "Relatorio Financeiro Litoral Brasil\n";
        t += "-----------------------------------\n";
        
        salesHistory.forEach(s => {
            const shortMethod = shortenMethod(s.method);
            t += `${s.date} | ${s.client} | ${shortMethod} | R$ ${s.total.toFixed(2)}\nItem: ${s.items}\n----------------\n`;
        });

        // O "\uFEFF" √© a m√°gica que faz o Windows abrir com acentos certos
        const blob = new Blob(["\uFEFF"+t], {type: 'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Relatorio_Litoral_Brasil.txt';
        a.click();
    }

    function openBuilder(){ 
        selTop=null; selBot=null; openModal('modal-builder'); 
        const rt=document.getElementById('list-tops'); const rb=document.getElementById('list-bottoms'); 
        rt.innerHTML = inventory.filter(i=>i.type==='Suti√£'&&i.qty>0).map(i => 
            `<div class="b-item" onclick="selPart('top','${i.id}',this)"><img src="${i.img||NO_IMG}" style="width:40px;margin-right:10px;">${i.name}</div>`
        ).join('');
        rb.innerHTML = inventory.filter(i=>i.type==='Calcinha'&&i.qty>0).map(i => 
            `<div class="b-item" onclick="selPart('bot','${i.id}',this)"><img src="${i.img||NO_IMG}" style="width:40px;margin-right:10px;">${i.name}</div>`
        ).join('');
    }
    function selPart(t,id,el){
        const i=inventory.find(x=>x.id===id); if(t==='top')selTop=i; else selBot=i;
        Array.from(el.parentNode.children).forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
        document.getElementById('build-total').innerText=((selTop?selTop.price:0)+(selBot?selBot.price:0)).toFixed(2);
    }
    function addComboToCart(){ if(selTop)addToCart(selTop.id); if(selBot)addToCart(selBot.id); closeAll(); }
</script>
</body>
</html>
